= Readme

Launch EKS cluster using `eksctl`, Install a workload into cluster via ALB Ingress.

You need to install

. kubectl[https://kubectl.docs.kubernetes.io/]
. helm[https://helm.sh/docs/intro/install/]
. aws-cli[https://github.com/aws/aws-cli]
. eksctl[https://eksctl.io/]

It installs AWS Load Balancer controller (This is AWS LoadBalancer, not Application LoadBalancer). AWS LoadBalancer is refers to all load balancers --- Application LoadBalancer (ALB), Network LoadBalancer (NLB) & Elastic LoadBalancer (ELB) i.e AWS LB â‰  ALB, AWS LB = ALB &/ NLB &/ ELB.

== Quasi-Declarative version

=== Create cluster

[source,shell]
----
eksctl create cluster -f eksctl-workload-cluster.yml
----

=== Install Ingress CRDs

[source,shell]
----
# to know what gets created, without applying them explicitly
kubectl apply -k "github.com/aws/eks-charts/stable/aws-load-balancer-controller//crds?ref=master" --dry-run='server'

kubectl apply -k "github.com/aws/eks-charts/stable/aws-load-balancer-controller//crds?ref=master"
----

=== Install AWS Load Balancer Controller

[source,shell]
----
helm repo add eks https://aws.github.io/eks-charts

helm upgrade -i aws-load-balancer-controller eks/aws-load-balancer-controller \
    -n kube-system \
    --set clusterName=workload \
    --set serviceAccount.create=false \
    --set serviceAccount.name=workload-sa
----

=== Ingress (L7 - ALB) workload

==== Using kubectl

===== Install

[source,shell]
----
kubectl apply -f workload-alb-full.yaml
----

===== List all resources

[source,shell]
----
kubectl get all -A
----

===== Get Ingresses

[source,shell]
----
kubectl get ing -A
----

Access url via

[source,shell]
----
curl -v -k <ing_url>
----

or in browser

===== Uninstall

[source,shell]
----
kubectl delete -f workload-alb-full.yaml
----

==== Using helm

===== Install

[source,shell]
----
helm upgrade --install workload workload-alb-chart
----

===== List all resources

[source,shell]
----
kubectl get all -A
----

===== Get Ingress resources

[source,shell]
----
kubectl get ing -A
----

Access url via

[source,shell]
----
curl -v -k <ing_url>
----

or in browser

===== Uninstall

[source,shell]
----
helm uninstall workload
----

=== L4 Service LoadBalancer (L4 - NLB) workload

==== Using kubectl

===== Install

[source,shell]
----
kubectl apply -f workload-nlb-full.yaml
----

===== List all resources

[source,shell]
----
kubectl get all -A
----

===== Get Services

[source,shell]
----
kubectl get svc -A
----

Access url via

[source,shell]
----
curl -v -k <ing_url>
----

or in browser

===== Uninstall

[source,shell]
----
kubectl delete -f workload-nlb-full.yaml
----

==== Using helm

===== Install

[source,shell]
----
helm upgrade --install workload workload-nlb-chart
----

===== List all resources

[source,shell]
----
kubectl get all -A
----

===== Get Services

[source,shell]
----
kubectl get svc -A
----

Access url via

[source,shell]
----
curl -v -k <ing_url>
----

or in browser

===== Uninstall

[source,shell]
----
helm uninstall workload
----

=== Delete cluster

[source,shell]
----
eksctl delete cluster --name workload
----

== Imperative version

[source,shell]
----
# Create cluster
eksctl create cluster \
    --name workload \
    --region ap-south-1 \
    --version 1.24 \
    --nodegroup-name workload-ng \
    --instance-prefix workload-ng-instance \
    --node-type t3.medium \
    --nodes 2 \
    --nodes-min 2 \
    --nodes-max 2 \
    --max-pods-per-node 100 \
    --node-volume-size 20 \
    --node-volume-type gp2 \
    --node-ami-family Ubuntu2004 \
    --alb-ingress-access

# Enable OIDC with cluster
eksctl utils associate-iam-oidc-provider \
    --region ap-south-1 \
    --cluster workload \
    --approve

# Creat IAM policy for AWS loadbalancer controller
curl -o iam-policy.json https://raw.githubusercontent.com/kubernetes-sigs/aws-load-balancer-controller/main/docs/install/iam_policy.json

aws iam create-policy \
    --policy-name AWSLoadBalancerControllerIAMPolicy \
    --policy-document file://iam-policy.json

# List loadbalancer policy & note ARN
aws iam list-policies --query "Policies[?PolicyName == 'AWSLoadBalancerControllerIAMPolicy'].Arn"

# Create service account & link it to AWS IAM policy
eksctl create iamserviceaccount \
    --cluster=workload \
    --namespace=kube-system \
    --name=workload-sa \
    --attach-policy-arn=arn:aws:iam::<account_id>:policy/AWSLoadBalancerControllerIAMPolicy \
    --approve

# Install AWS Load Balancer Controller
helm repo add eks https://aws.github.io/eks-charts

helm upgrade -i aws-load-balancer-controller eks/aws-load-balancer-controller \
    -n kube-system \
    --set clusterName=workload \
    --set serviceAccount.create=false \
    --set serviceAccount.name=workload-sa

# Install Ingress (L7 - ALB) workload (using kubectl)
kubectl apply -f workload-alb-full.yaml

# List all resources
kubectl get all -A

# Get Ingress resources
kubectl get ing -A

# (or) Access url via
curl -v -k ing_url
# or in browser

# Uninstall Ingress workload
kubectl delete -f workload-alb-full.yaml

# Install Ingress workload (using helm)
helm upgrade --install workload workload-alb-chart

# Uninstall Ingress workload
helm uninstall workload

# Install L4 Service LoadBalancer (L4 - NLB) workload (using kubectl)
kubectl apply -f workload-nlb-full.yaml

# List all resources
kubectl get all -A

# Get Service resources
kubectl get svc -A

# (or) Access url via
curl -v -k ing_url
# or in browser

# Uninstall Ingress workload
kubectl delete -f workload-nlb-full.yaml

# Install Ingress workload (using helm)
helm upgrade --install workload workload-nlb-chart

# Uninstall Ingress workload
helm uninstall workload

# List loadbalancer policy & note ARN
aws iam list-policies --query "Policies[?PolicyName == 'AWSLoadBalancerControllerIAMPolicy'].Arn"

# Delete loadbalancer policy
aws iam delete-policy \
    --policy-arn arn:aws:iam::<account_id>:policy/AWSLoadBalancerControllerIAMPolicy

# Delete service account
#eksctl delete iamserviceaccount \
#    --cluster=workload \
#    --namespace=kube-system \
#    --name=workload-sa

# Delete cluster
eksctl delete cluster --name workload
----

== References

Read more at

. https://docs.aws.amazon.com/eks/latest/userguide/network-load-balancing.html[Network load balancing on Amazon EKS]
. https://docs.aws.amazon.com/eks/latest/userguide/alb-ingress.html[Application load balancing on Amazon EKS]
. https://github.com/aws/eks-charts/tree/master/stable/aws-load-balancer-controller[AWS Load Balancer Controller]
